{% extends 'base.html' %}

{% block title %}Manage Projects{% endblock %}

{% block headnav %}

<div class="navbar shadow rounded-0 p-3 " style="background-color: #294867; border: none;">

    <div>
        <h4>Manage projects</h4>
    </div>
    
    <div class=" d-flex rounded-0 justify-content-end">
        <a href="{{ url_for('index') }}" class="btn btn-primary rounded-0">Home</a>
        <button type="button" class="btn btn-secondary rounded-0" onclick="goBack()">Previous Page</button>
    </div>
</div>



{% endblock %}

{% block content %}


    <div class="row">
        <div class="col-md-4">
            <div class="card mb-4 shadow rounded-0" style="border: none;">
                <div class="card-header  text-white rounded-0" style="background-color: #38a3a5;">
                    <h5 class="pt-2">Add New Project</h5>
                </div>
                <div class="card-body">
                    <form method="POST" class="d-flex rounded-0" action="{{ url_for('manage_projects') }}">
                        <input type="text" name="project_name" class="form-control me-2 rounded-0" placeholder="Project Name" required>
                        <button type="submit" class="btn btn-primary rounded-0">Add Project</button>
                    </form>
                </div>
            </div>

            <div class="card shadow rounded-0" style="border: none;">
                <div class="card-header text-white rounded-0" style="background-color: #38a3a5;">
                    <h5 class="pt-2">Existing Projects</h5>
                </div>
                <div class="card-body rounded-0">
                    <input type="text" id="search" class="form-control mb-3 rounded-0" placeholder="Search Projects">
                    <div style="height: 300px; overflow-y: auto;">
                        <ul class="list-group rounded-0" id="projectList"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8" id="servicesContainer">
            <div class="alert alert-info">Select a project to see its services.</div>
        </div>
    </div>




<script>
    function loadProjects(searchQuery = '') {
        fetch(`/api/projects?search=${searchQuery}`)
            .then(response => response.json())
            .then(projects => {
                const projectList = document.getElementById('projectList');
                projectList.innerHTML = '';
                projects.forEach(project => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item d-flex justify-content-between align-items-center rounded-0';
                    li.style.cursor = 'pointer';
                    li.onclick = () => loadProjectServices(project.id);
                    li.innerHTML = `${project.name} <span class="badge bg-secondary">${project.service_count} Services</span>`;
                    projectList.appendChild(li);
                });
            })
            .catch(error => console.error('Error fetching projects:', error));
    }

    function loadProjectServices(projectId) {
    fetch(`/api/project/${projectId}`)
        .then(response => response.json())
        .then(data => {
            const servicesContainer = document.getElementById('servicesContainer');
            servicesContainer.innerHTML = `
                <div class="card mb-4 shadow rounded-0" style="border: none;">
                    <div class="card-header text-white rounded-0 " style="background-color: #38a3a5;">
                        <h5 class="pt-2">Services for ${data.project_name} (${data.services.length})</h5>
                    </div>
                    <div class="card-body rounded-0">
                        <ul class="list-group rounded-0">
                            ${data.services.map(service => `
                                <li class="list-group-item rounded-0 d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>Service Name:</strong> ${service.name}<br>
                                        <strong>Service Type:</strong> ${service.type}<br>
                                        <strong>Status:</strong> ${service.status}<br>
                                        <strong>Cloud provider:</strong> ${service.provider}
                                    </div>
                                    <a href="/edit_service/${service.id}" class="btn btn-warning btn-sm rounded-0">Edit</a>
                                </li>`).join('')}
                        </ul>
                    </div>
                    <div class="card-footer">
                        <a href="/download_services/${projectId}" class="btn btn-success btn-sm rounded-0">Download Services</a>
                    </div>
                </div>`;
        })
        .catch(error => console.error('Error fetching project services:', error));
}


    document.getElementById('search').addEventListener('input', (event) => {
        loadProjects(event.target.value);
    });

    // Load initial projects
    loadProjects();
    
    function goBack() {
    // Get the stored previous page URL
    const previousUrl = sessionStorage.getItem('previousPage');
    
    if (previousUrl) {
        // Redirect to the previous page and force a reload
        window.location.href = previousUrl;
        // Optionally, clear the sessionStorage if you don't want to keep it
        sessionStorage.removeItem('previousPage');
    } else {
        // Fallback to going back in history if no previous URL is found
        window.history.back();
    }
}
</script>
{% endblock %}
